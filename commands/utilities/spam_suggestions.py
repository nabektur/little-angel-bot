import typing
import discord

from discord import app_commands
from discord.ext import commands

from modules.configuration import config

from classes.database import db
from classes.bot      import LittleAngelBot

class SuggestSpamView(discord.ui.View):
    def __init__(self, user_id: int, suggestion: str, spam_type: str):
        super().__init__(timeout=None)
        self.user_id = user_id
        self.suggestion = suggestion
        self.spam_type = spam_type

    @discord.ui.button(style=discord.ButtonStyle.blurple, custom_id="spam_suggestion_accept", emoji="‚òëÔ∏è")
    async def accept(self, interaction: discord.Interaction, button: discord.ui.Button):
        table = "spamtexts_nsfw" if self.spam_type == "nsfw" else "spamtexts_ordinary"
        await db.execute(f"INSERT INTO {table} (text) VALUES (?) ON CONFLICT DO NOTHING;", self.suggestion)
        await interaction.message.delete()
        await interaction.response.send_message(embed=discord.Embed(description=f"‚òëÔ∏è –¢–µ–∫—Å—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –±–∞–∑—É (`{self.spam_type}`).", color=config.LITTLE_ANGEL_COLOR), ephemeral=True)

    @discord.ui.button(style=discord.ButtonStyle.danger, custom_id="spam_suggestion_reject", emoji="‚úñÔ∏è")
    async def reject(self, interaction: discord.Interaction, button: discord.ui.Button):
        await interaction.message.delete()
        await interaction.response.send_message(embed=discord.Embed(description="‚ùå –¢–µ–∫—Å—Ç –æ—Ç–∫–ª–æ–Ω—ë–Ω.", color=0xff0000), ephemeral=True)

    @discord.ui.button(style=discord.ButtonStyle.secondary, custom_id="spam_suggestion_block", emoji="üö´")
    async def block(self, interaction: discord.Interaction, button: discord.ui.Button):
        await db.execute("INSERT INTO blocked_users (user_id, reason) VALUES (?, ?) ON CONFLICT (user_id) DO NOTHING;", self.user_id, "–ó–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ª–æ–∂–∫–æ–π")
        await interaction.message.delete()
        await interaction.response.send_message(embed=discord.Embed(description="üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.", color=0xff0000), ephemeral=True)


class SpamSuggestion(commands.Cog):
    def __init__(self, bot: LittleAngelBot):
        self.bot = bot
        bot.add_view(SuggestSpamView(0, "", "ordinary"))

    suggestion_group = app_commands.Group(
        name="–ø—Ä–µ–¥–ª–æ–∂–∫–∞",
        description="–ü—Ä–µ–¥–ª–æ–∂–∏—Ç–µ —á—Ç–æ-–ª–∏–±–æ"
    )

    class SpamSuggestionModal(discord.ui.Modal, title='–ö–∞—Å—Ç–æ–º–Ω—ã–π —Ç–µ–∫—Å—Ç'):
        def __init__(self, bot: LittleAngelBot, type: typing.Literal["ordinary", "nsfw"]):
            super().__init__()
            self.bot = bot
            self.type = type

        text = discord.ui.TextInput(
            label='–¢–µ–∫—Å—Ç:',
            placeholder='–í–≤–µ–¥–∏—Ç–µ —Å—é–¥–∞ —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –¥–ª—è —Å–ø–∞–º–∞',
            required=True,
            style=discord.TextStyle.long
        )

        async def on_submit(self, interaction: discord.Interaction):
            user_id = interaction.user.id

            blocked = await db.fetchone("SELECT * FROM blocked_users WHERE user_id = ?", user_id)
            if blocked:
                return await interaction.response.send_message(embed=discord.Embed(description="‚ùå –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å —Ç–µ–∫—Å—Ç—ã.", color=0xff0000), ephemeral=True)

            embed = discord.Embed(title="‚ú® –ù–æ–≤—ã–π –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è —Å–ø–∞–º–∞", description=self.text.value, color=config.LITTLE_ANGEL_COLOR)
            embed.set_footer(text=f"–û—Ç: {interaction.user} ({user_id}) | –¢–∏–ø: {self.type}")

            channel = self.bot.get_channel(int(config.SPAM_SUGGESTIONS_CHANNEL_ID.get_secret_value()))
            if channel:
                await channel.send(embed=embed, view=SuggestSpamView(user_id, self.text.value, self.type))

            await interaction.response.send_message(embed=discord.Embed(description="‚úâÔ∏è –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é!", color=config.LITTLE_ANGEL_COLOR), ephemeral=True)


    @suggestion_group.command(name="—Å–ø–∞–º", description="–ü—Ä–µ–¥–ª–æ–∂–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è —Å–ø–∞–º–∞")
    @app_commands.choices(type=[app_commands.Choice(name="–°–ø–∞–º –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤", value="ordinary"), app_commands.Choice(name="–°–ø–∞–º –¥–ª—è nsfw –∫–∞–Ω–∞–ª–æ–≤", value="nsfw")])
    @app_commands.describe(type="–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Å–ø–∞–º–∞")
    async def suggest_spam(self, interaction: discord.Interaction, type: typing.Literal["ordinary", "nsfw"]):

        blocked = await db.fetchone("SELECT * FROM blocked_users WHERE user_id = ?", interaction.user.id)
        if blocked:
            return await interaction.response.send_message(embed=discord.Embed(description="‚ùå –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å —Ç–µ–∫—Å—Ç—ã.", color=0xff0000), ephemeral=True)

        modal = self.SpamSuggestionModal(
            bot=self.bot,
            type=type
        )
        return await interaction.response.send_modal(modal)


async def setup(bot: LittleAngelBot):
    await bot.add_cog(SpamSuggestion(bot))
